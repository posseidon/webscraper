<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>Quiz Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'quiz-yellow': '#fce883',
                        'quiz-yellow-light': '#ffec8b'
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif']
                    },
                    boxShadow: {
                        'paper': '0.5rem 0.5rem 0 black',
                        'paper-hover': '0.8rem 0.8rem 0 black',
                        'paper-sm': '0.25rem 0.25rem 0 black'
                    },
                    animation: {
                        'correct-pulse': 'correctPulse 0.8s ease',
                        'wrong-shake': 'wrongShake 0.6s ease',
                        'correct-glow': 'correctTextGlow 0.8s ease',
                        'wrong-glow': 'wrongTextGlow 0.6s ease'
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" th:href="@{/css/quiz-play-tailwind.css}">
</head>
<body class="min-h-screen bg-quiz-yellow font-inter p-4 flex justify-center items-start overflow-x-hidden touch-manipulation">
<div class="bg-white rounded-2xl border-4 border-black shadow-paper w-full max-w-4xl min-h-96 overflow-hidden">
    <!-- Progress Bar -->
    <div class="bg-gray-100 p-4 md:p-5 border-b-2 border-gray-200 text-center">
        <div class="bg-gray-300 h-2 rounded-full overflow-hidden mb-3">
            <div class="bg-gradient-to-r from-green-500 to-teal-500 h-full w-0 transition-all duration-300 ease-in-out" id="progressFill"></div>
        </div>
        <span class="text-sm text-gray-600 font-medium">
            Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions" th:text="${total}">10</span>
        </span>
    </div>

    <!-- Question Container -->
    <div class="question-container p-5 md:p-8 transition-all duration-500 relative overflow-hidden" id="questionContainer">
        <!-- Question Text -->
        <h2 class="question-text text-xl md:text-2xl leading-relaxed mb-8 text-gray-800 font-medium bg-white p-6 md:p-8 rounded-3xl border-4 border-black shadow-paper relative overflow-hidden transition-all duration-300 hover:transform hover:-translate-x-1 hover:-translate-y-1 hover:shadow-paper-hover" id="questionText">Loading question...</h2>
        
        <!-- Options Container -->
        <div class="options-container mb-6" id="optionsContainer">
            <!-- Options will be populated by JavaScript -->
        </div>
        
        <!-- Explanation Container -->
        <div class="explanation-container bg-quiz-yellow-light border-4 border-black rounded-3xl shadow-paper-sm p-5 my-6 hidden" id="explanationContainer">
            <h4 class="text-gray-800 mb-3 text-lg font-semibold">Explanation:</h4>
            <p class="text-gray-700 leading-relaxed" id="explanationText"></p>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons text-center mt-8">
            <button id="submitBtn" class="btn btn-primary bg-black text-white font-bold text-lg px-8 py-3 rounded-xl border-4 border-black shadow-paper transition-all duration-200 hover:transform hover:-translate-x-1 hover:-translate-y-1 hover:shadow-paper-hover active:transform active:translate-x-0 active:translate-y-0 active:shadow-none mx-2 min-h-11 min-w-11 inline-flex items-center justify-center select-none" onclick="submitAnswer()">Submit Answer</button>
            <button id="nextBtn" class="btn btn-secondary bg-black text-white font-bold text-lg px-8 py-3 rounded-xl border-4 border-black shadow-paper transition-all duration-200 hover:transform hover:-translate-x-1 hover:-translate-y-1 hover:shadow-paper-hover active:transform active:translate-x-0 active:translate-y-0 active:shadow-none mx-2 min-h-11 min-w-11 inline-flex items-center justify-center select-none hidden" onclick="nextQuestion()">Next Question</button>
            <button id="evaluateBtn" class="btn btn-success bg-black text-white font-bold text-lg px-8 py-3 rounded-xl border-4 border-black shadow-paper transition-all duration-200 hover:transform hover:-translate-x-1 hover:-translate-y-1 hover:shadow-paper-hover active:transform active:translate-x-0 active:translate-y-0 active:shadow-none mx-2 min-h-11 min-w-11 inline-flex items-center justify-center select-none hidden" onclick="showEvaluation()">Evaluate Quiz</button>
        </div>
    </div>

    <!-- Results Container (hidden initially) -->
    <div class="results-container p-10 md:p-12 text-center hidden" id="resultsContainer">
        <h2 class="text-3xl md:text-4xl mb-8 text-gray-800 font-bold">Quiz Results</h2>
        
        <!-- Score Summary -->
        <div class="score-summary mb-10">
            <div class="score-circle w-32 h-32 md:w-36 md:h-36 rounded-full bg-quiz-yellow-light border-4 border-black shadow-paper flex items-center justify-center mx-auto mb-5">
                <span class="text-2xl md:text-3xl font-bold text-gray-800" id="scorePercentage">0%</span>
            </div>
            <p class="text-lg md:text-xl text-gray-700">You got <span class="font-bold text-gray-800" id="correctAnswers">0</span> out of <span class="font-bold" id="totalQuestionsResult">0</span> questions correct!</p>
        </div>
        
        <!-- Wrong Answers Section -->
        <div class="wrong-answers-section text-left mb-10" id="wrongAnswersSection">
            <h3 class="text-xl mb-5 text-gray-800 text-center font-semibold">Review Wrong Answers:</h3>
            <div id="wrongAnswersList" class="space-y-5">
                <!-- Wrong answers will be populated here -->
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons space-y-4 md:space-y-0 md:space-x-4">
            <button class="btn btn-primary w-full md:w-auto bg-black text-white font-bold text-lg px-8 py-3 rounded-xl border-4 border-black shadow-paper transition-all duration-200 hover:transform hover:-translate-x-1 hover:-translate-y-1 hover:shadow-paper-hover active:transform active:translate-x-0 active:translate-y-0 active:shadow-none min-h-11 min-w-11 inline-flex items-center justify-center select-none" onclick="finishQuiz()">Finish Quiz</button>
            <button class="btn btn-secondary w-full md:w-auto bg-black text-white font-bold text-lg px-8 py-3 rounded-xl border-4 border-black shadow-paper transition-all duration-200 hover:transform hover:-translate-x-1 hover:-translate-y-1 hover:shadow-paper-hover active:transform active:translate-x-0 active:translate-y-0 active:shadow-none min-h-11 min-w-11 inline-flex items-center justify-center select-none" onclick="retryQuiz()">Try Again</button>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script th:inline="javascript">
    const questions = /*[[${questions}]]*/ [];
    const totalQuestions = /*[[${total}]]*/ 0;
    
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let quizResults = {
        totalQuestions: totalQuestions,
        correctAnswers: 0,
        wrongAnswers: [],
        completedAt: null
    };
    
    // Initialize quiz
    document.addEventListener('DOMContentLoaded', function() {
        loadQuestion(0);
        updateProgress();
    });
    
    function loadQuestion(index) {
        if (index >= questions.length) return;
        
        const question = questions[index];
        currentQuestionIndex = index;
        
        document.getElementById('topicName').textContent = question.topic_name || 'Unknown Topic';
        document.getElementById('currentQuestionNum').textContent = index + 1;
        document.getElementById('questionText').textContent = question.question;
        
        // Set difficulty badge with class and formatted text
        const difficultyBadge = document.getElementById('difficultyBadge');
        const difficulty = (question.difficulty || 'Medium').toLowerCase();
        const difficultyIcons = {
            'easy': '😊',
            'könnyű': '😊',
            'medium': '🤔',
            'közepes': '🤔',
            'hard': '😤',
            'nehéz': '😤',
            'mixed': '🎲',
            'vegyes': '🎲'
        };
        
        const icon = difficultyIcons[difficulty] || '📝';
        difficultyBadge.className = 'difficulty-badge ' + (difficultyIcons[difficulty] ? difficulty : 'medium');
        difficultyBadge.innerHTML = icon + ' ' + (question.difficulty || 'Medium') + '';
        
        // Load options
        const optionsContainer = document.getElementById('optionsContainer');
        optionsContainer.innerHTML = '';
        
        question.options.forEach((option, optionIndex) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option';
            optionDiv.innerHTML = `
                <input type="radio" name="answer" value="${optionIndex}" id="option${optionIndex}">
                <label for="option${optionIndex}">${option}</label>
            `;
            optionsContainer.appendChild(optionDiv);
        });
        
        // Reset UI state
        document.getElementById('explanationContainer').style.display = 'none';
        document.getElementById('submitBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('evaluateBtn').style.display = 'none';
        
        // Clear previous selections
        document.querySelectorAll('input[name="answer"]').forEach(input => {
            input.checked = false;
            input.disabled = false;
        });
        
        // Remove previous result classes
        document.querySelectorAll('.option').forEach(opt => {
            opt.classList.remove('correct', 'incorrect', 'selected', 'dimmed');
        });
        
        // Clear any animation classes from question container
        const questionContainer = document.getElementById('questionContainer');
        questionContainer.classList.remove('correct-answer', 'wrong-answer');
        
        updateProgress();
    }
    
    function submitAnswer() {
        const selectedOption = document.querySelector('input[name="answer"]:checked');
        if (!selectedOption) {
            alert('Please select an answer');
            return;
        }
        
        const selectedAnswer = parseInt(selectedOption.value);
        const question = questions[currentQuestionIndex];
        const correctAnswer = question.correctAnswer || question.correct_answer;
        const isCorrect = selectedAnswer === correctAnswer;
        
        // Debug logging
        console.log('Selected Answer:', selectedAnswer);
        console.log('Correct Answer:', correctAnswer);
        console.log('Question object:', question);
        console.log('Is Correct:', isCorrect);
        
        // Store user answer
        userAnswers[currentQuestionIndex] = {
            questionIndex: currentQuestionIndex,
            selectedAnswer: selectedAnswer,
            correctAnswer: correctAnswer,
            isCorrect: isCorrect,
            question: question
        };
        
        // Update results and add animations
        const questionContainer = document.getElementById('questionContainer');
        
        // Clear any existing animation classes first
        questionContainer.classList.remove('correct-answer', 'wrong-answer');
        
        if (isCorrect) {
            quizResults.correctAnswers++;
            // Force a reflow to ensure the class removal takes effect
            questionContainer.offsetHeight;
            questionContainer.classList.add('correct-answer');
            // Remove animation class after animation completes
            setTimeout(() => {
                questionContainer.classList.remove('correct-answer');
            }, 800);
        } else {
            quizResults.wrongAnswers.push(userAnswers[currentQuestionIndex]);
            // Force a reflow to ensure the class removal takes effect
            questionContainer.offsetHeight;
            questionContainer.classList.add('wrong-answer');
            // Remove animation class after animation completes
            setTimeout(() => {
                questionContainer.classList.remove('wrong-answer');
            }, 600);
        }
        
        // Disable all options and show results
        document.querySelectorAll('input[name="answer"]').forEach(input => {
            input.disabled = true;
        });
        
        // Highlight correct and incorrect answers
        document.querySelectorAll('.option').forEach((option, index) => {
            if (index === correctAnswer) {
                option.classList.add('correct');
            } else if (index === selectedAnswer && !isCorrect) {
                option.classList.add('incorrect');
            }
            if (index === selectedAnswer) {
                option.classList.add('selected');
            }
            
            // Dim non-relevant options for wrong answers
            if (!isCorrect && index !== correctAnswer && index !== selectedAnswer) {
                option.classList.add('dimmed');
            }
        });
        
        // Show explanation
        if (question.explanation) {
            document.getElementById('explanationText').textContent = question.explanation;
            document.getElementById('explanationContainer').style.display = 'block';
        }
        
        // Show appropriate button
        document.getElementById('submitBtn').style.display = 'none';
        if (currentQuestionIndex < questions.length - 1) {
            document.getElementById('nextBtn').style.display = 'inline-block';
        } else {
            document.getElementById('evaluateBtn').style.display = 'inline-block';
        }
    }
    
    function nextQuestion() {
        if (currentQuestionIndex < questions.length - 1) {
            loadQuestion(currentQuestionIndex + 1);
        }
    }
    
    function updateProgress() {
        const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
    }
    
    function showEvaluation() {
        quizResults.completedAt = new Date().toISOString();
        
        // Hide question container
        document.getElementById('questionContainer').style.display = 'none';
        
        // Show results container
        document.getElementById('resultsContainer').style.display = 'block';
        
        // Calculate and display score
        const percentage = Math.round((quizResults.correctAnswers / quizResults.totalQuestions) * 100);
        document.getElementById('scorePercentage').textContent = percentage + '%';
        document.getElementById('correctAnswers').textContent = quizResults.correctAnswers;
        document.getElementById('totalQuestionsResult').textContent = quizResults.totalQuestions;
        
        // Show wrong answers if any
        if (quizResults.wrongAnswers.length > 0) {
            const wrongAnswersList = document.getElementById('wrongAnswersList');
            wrongAnswersList.innerHTML = '';
            
            quizResults.wrongAnswers.forEach((wrongAnswer, index) => {
                const wrongAnswerDiv = document.createElement('div');
                wrongAnswerDiv.className = 'wrong-answer-item';
                wrongAnswerDiv.innerHTML = `
                    <div class="wrong-question">
                        <strong>Question ${wrongAnswer.questionIndex + 1}:</strong> ${wrongAnswer.question.question}
                    </div>
                    <div class="wrong-details">
                        <div class="your-answer">
                            <span class="label">Your Answer:</span> 
                            <span class="incorrect-text">${wrongAnswer.question.options[wrongAnswer.selectedAnswer]}</span>
                        </div>
                        <div class="correct-answer">
                            <span class="label">Correct Answer:</span> 
                            <span class="correct-text">${wrongAnswer.question.options[wrongAnswer.correctAnswer]}</span>
                        </div>
                        ${wrongAnswer.question.explanation ? `
                        <div class="explanation">
                            <span class="label">Explanation:</span> ${wrongAnswer.question.explanation}
                        </div>
                        ` : ''}
                    </div>
                `;
                wrongAnswersList.appendChild(wrongAnswerDiv);
            });
        } else {
            document.getElementById('wrongAnswersSection').style.display = 'none';
        }
    }
    
    function finishQuiz() {
        // Send results to server
        fetch('/quiz/submit-results', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(quizResults)
        })
        .then(response => response.json())
        .then(data => {
            // Redirect to subjects page or show success message
            window.location.href = '/quiz/subjects';
        })
        .catch(error => {
            console.error('Error submitting results:', error);
            // Still redirect on error
            window.location.href = '/quiz/subjects';
        });
    }
    
    function retryQuiz() {
        // Reset all variables
        currentQuestionIndex = 0;
        userAnswers = [];
        quizResults = {
            totalQuestions: totalQuestions,
            correctAnswers: 0,
            wrongAnswers: [],
            completedAt: null
        };
        
        // Show question container and hide results
        document.getElementById('questionContainer').style.display = 'block';
        document.getElementById('resultsContainer').style.display = 'none';
        
        // Load first question
        loadQuestion(0);
    }
</script>
</body>
</html>