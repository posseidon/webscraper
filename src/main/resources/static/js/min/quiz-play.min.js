let questions=[],totalQuestions=0,currentQuestionIndex=0,selectedAnswers=[],correctAnswers=0,wrongAnswers=[],quizResults={},currentLanguageFilter="all";function initializeQuizData(e){questions=e||[],totalQuestions=questions.length,quizResults={totalQuestions:totalQuestions,correctAnswers:0,wrongAnswers:[],completedAt:null}}function setupEventListeners(){var e=document.getElementById("actionBtn"),e=(e&&e.addEventListener("click",handleActionButton),document.getElementById("finishQuizBtn")),e=(e&&e.addEventListener("click",finishQuiz),document.getElementById("close-explanation-modal")),t=document.getElementById("close-explanation-modal-footer"),n=document.getElementById("continue-quiz-btn"),e=(e&&e.addEventListener("click",function(e){e.preventDefault(),hideExplanationModal()}),t&&t.addEventListener("click",function(e){e.preventDefault(),hideExplanationModal()}),n&&n.addEventListener("click",function(e){e.preventDefault(),hideExplanationModal(),(currentQuestionIndex<questions.length-1?nextQuestion:showEvaluation)()}),document.getElementById("goto-quiz-btn")),t=(e&&e.addEventListener("click",function(e){e.preventDefault();e=document.getElementById("quiz-card");e.style.transform="rotateY(180deg)"===e.style.transform?"":"rotateY(180deg)"}),document.getElementById("close-settings-btn"));t&&t.addEventListener("click",function(e){e.preventDefault();e=document.getElementById("quiz-card");e.style.transform="rotateY(180deg)"===e.style.transform?"":"rotateY(180deg)"})}function loadQuestion(e){if(e>=questions.length)showEvaluation();else{hideExplanationModal();var t=questions[e],n=(currentQuestionIndex=e,document.getElementById("currentQuestionNum")),r=document.getElementById("totalQuestions"),n=(n&&(n.textContent=e+1),r&&(r.textContent=totalQuestions),document.getElementById("questionText"));n&&(n.textContent=t.question,n.removeAttribute("data-translate"));let a=document.getElementById("optionsContainer");a.innerHTML="",t.options.forEach((e,t)=>{var n=document.createElement("div");n.className="option-card cursor-pointer p-4 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200",n.setAttribute("data-option-index",t),n.innerHTML=`
            <div class="flex items-center">
                <input type="radio" name="answer" value="${t}" class="w-4 h-4 text-blue-600 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 border-none bg-transparent">
                <label class="ml-3 text-sm text-gray-900 dark:text-white font-medium cursor-pointer">${e}</label>
            </div>
        `,n.addEventListener("click",function(){selectOption(t)}),n.style.pointerEvents="auto",a.appendChild(n)});e=document.getElementById("actionBtn"),n=(e&&(e.innerHTML='<span data-translate="quiz.submit_answer">Submit Answer</span>',e.className="inline-flex items-center text-sm font-bold text-red-600 dark:text-red-400 dark:hover:text-white",e.dataset.mode="submit",e.disabled=!0,window.languageManager)&&(r=e.querySelector("span"))&&(r.textContent=window.languageManager.translate("quiz.submit_answer")),document.getElementById("bottom-banner"));n&&n.classList.add("hidden"),setTimeout(()=>{applyLanguageFilter(),updateFilterButtonStates()},50)}}function selectOption(e){document.querySelectorAll(".option-card").forEach(e=>{e.classList.remove("bg-blue-100","dark:bg-blue-900","border-blue-500"),e.classList.add("border-gray-300","dark:border-gray-600")});e=document.querySelector(`[data-option-index="${e}"]`);e.classList.remove("border-gray-300","dark:border-gray-600"),e.classList.add("bg-blue-100","dark:bg-blue-900","border-blue-500");e.querySelector('input[type="radio"]').checked=!0;e=document.getElementById("actionBtn");e&&(e.disabled=!1)}function submitAnswer(){var e=document.querySelector('input[name="answer"]:checked');if(e){let r=parseInt(e.value);e=questions[currentQuestionIndex];let i=e.correctAnswer||e.correct_answer;selectedAnswers[currentQuestionIndex]=r,document.querySelectorAll(".option-card").forEach((e,t)=>{var n,a=t===r,t=t===i;e.classList.remove("bg-blue-100","dark:bg-blue-900","border-blue-500","border-gray-300","dark:border-gray-600","bg-green-100","dark:bg-green-900","border-green-500","bg-red-100","dark:bg-red-900","border-red-500"),t?(e.classList.add("bg-green-100","dark:bg-green-900","border-green-500","border-2"),(t=e.querySelector("label"))&&!t.querySelector(".correct-icon")&&((n=document.createElement("span")).className="correct-icon ml-2 text-green-600 dark:text-green-400",n.innerHTML="✓",t.appendChild(n))):a?(e.classList.add("bg-red-100","dark:bg-red-900","border-red-500","border-2"),(t=e.querySelector("label"))&&!t.querySelector(".wrong-icon")&&((n=document.createElement("span")).className="wrong-icon ml-2 text-red-600 dark:text-red-400",n.innerHTML="✗",t.appendChild(n))):e.classList.add("border-gray-300","dark:border-gray-600"),e.style.pointerEvents="none"}),r===i?(correctAnswers++,quizResults.correctAnswers++):(wrongAnswers.push({questionIndex:currentQuestionIndex,question:e,selectedAnswer:r,correctAnswer:i}),quizResults.wrongAnswers.push({questionIndex:currentQuestionIndex,question:e,selectedAnswer:r,correctAnswer:i})),r!==i&&showExplanationModal(e.explanation);var t,e=document.getElementById("actionBtn");e&&(currentQuestionIndex<questions.length-1?(e.innerHTML='<span data-translate="quiz.next">Next</span>',e.className="inline-flex items-center text-sm font-bold text-red-600 dark:text-red-400 dark:hover:text-white",e.dataset.mode="next",window.languageManager&&(t=e.querySelector("span"))&&(t.textContent=window.languageManager.translate("quiz.next"))):(e.innerHTML='<span data-translate="quiz.finish">Finish Quiz</span>',e.className="inline-flex items-center text-sm font-bold text-red-600 dark:text-red-400 dark:hover:text-white",e.dataset.mode="evaluate",window.languageManager&&(t=e.querySelector("span"))&&(t.textContent=window.languageManager.translate("quiz.finish"))))}else alert("Please select an answer before submitting.")}function handleActionButton(e){e&&e.target&&("language-speed-dial-btn"===e.target.id||e.target.closest("#language-speed-dial-btn")||e.target.closest("#helper-speed-dial")||e.target.closest("#speed-dial-menu-bottom-right")||"vietnamese-filter-btn"===e.target.id||"hungarian-filter-btn"===e.target.id||"all-filter-btn"===e.target.id)?(e.preventDefault(),e.stopPropagation()):"submit"===(e=document.getElementById("actionBtn").dataset.mode)?submitAnswer():"next"===e?nextQuestion():"evaluate"===e&&showEvaluation()}function nextQuestion(){hideExplanationModal(),loadQuestion(currentQuestionIndex+1)}function showExplanationModal(e){var t=document.getElementById("explanation-modal"),n=document.getElementById("modal-explanation-text"),a=document.getElementById("helper-speed-dial");t&&n&&(a&&a.classList.add("hidden"),n.innerHTML="",n.removeAttribute("data-translate"),e&&e.trim()?n.textContent=e:window.languageManager?n.textContent=window.languageManager.translate("quiz.no_explanation")||"No explanation available for this question.":n.innerHTML='<span data-translate="quiz.no_explanation">No explanation available for this question.</span>',t.classList.remove("hidden"),t.classList.add("flex"),t.setAttribute("aria-hidden","false"),document.body.classList.add("overflow-hidden"))}function hideExplanationModal(){var e=document.getElementById("explanation-modal"),t=document.getElementById("helper-speed-dial");e&&!e.classList.contains("hidden")&&(e.classList.add("hidden"),e.classList.remove("flex"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("overflow-hidden"),t&&t.classList.remove("hidden"),e=document.getElementById("actionBtn"))&&"next"===e.dataset.mode&&(e.innerHTML='<span data-translate="quiz.submit_answer">Submit Answer</span>',e.dataset.mode="submit",e.disabled=!1,window.languageManager)&&(t=e.querySelector("span"))&&(t.textContent=window.languageManager.translate("quiz.submit_answer"))}function toggleSpeedDialMenu(){var e=document.getElementById("speed-dial-menu-bottom-right"),t=document.getElementById("language-speed-dial-btn");e&&t&&(e.classList.contains("hidden")?(e.classList.remove("hidden"),e.classList.add("flex"),e.style.display="flex",e.style.pointerEvents="auto",t.setAttribute("aria-expanded","true")):(e.classList.add("hidden"),e.classList.remove("flex"),e.style.display="none",e.style.pointerEvents="none",t.setAttribute("aria-expanded","false")))}function showEvaluation(){hideExplanationModal();var e=document.getElementById("helper-speed-dial"),e=(e&&e.classList.add("hidden"),document.getElementById("bottom-footer")),e=(e&&e.classList.add("hidden"),quizResults.completedAt=new Date,Math.round(correctAnswers/totalQuestions*100));document.getElementById("questionContainer").classList.add("hidden"),document.getElementById("resultsContainer").classList.remove("hidden"),document.getElementById("scorePercentage").textContent=e+"%",document.getElementById("correctAnswers").textContent=correctAnswers,document.getElementById("totalQuestionsResult").textContent=totalQuestions,0<wrongAnswers.length?displayWrongAnswers():document.getElementById("wrongAnswersSection").classList.add("hidden")}function displayWrongAnswers(){let n=document.getElementById("wrongAnswersList");n.innerHTML="",wrongAnswers.forEach(e=>{var t=document.createElement("div");t.className="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-sm p-6",t.innerHTML=`
            <div class="mb-4">
                <h4 class="text-base font-semibold text-gray-900 dark:text-white mb-2">
                    ${window.languageManager?window.languageManager.translate("quiz.question_label"):"Question"} ${e.questionIndex+1}:
                </h4>
                <p class="text-gray-700 dark:text-gray-300">${e.question.question}</p>
            </div>
            
            <div class="space-y-3">
                <div class="flex items-start space-x-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">
                        ${window.languageManager?window.languageManager.translate("quiz.your_answer"):"Your Answer"}
                    </span>
                    <span class="text-gray-700 dark:text-gray-300">${e.question.options[e.selectedAnswer]}</span>
                </div>
                
                <div class="flex items-start space-x-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">
                        ${window.languageManager?window.languageManager.translate("quiz.correct_answer"):"Correct Answer"}
                    </span>
                    <span class="text-gray-700 dark:text-gray-300">${e.question.options[e.correctAnswer]}</span>
                </div>
                
                ${e.question.explanation?`
                <div class="pt-3 border-t border-gray-200 dark:border-gray-700">
                    <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-1">${window.languageManager?window.languageManager.translate("quiz.explanation"):"Explanation:"}</h5>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${e.question.explanation}</p>
                </div>
                `:""}
            </div>
        `,n.appendChild(t)})}function finishQuiz(){fetch("/quiz/submit-results",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(quizResults)}).then(e=>e.json()).then(e=>{var t=window.category,n=window.subcategory,a=window.currentQuizTitle;window.location.href=t&&n&&a?`/quiz/${t}/${n}/`+a:"/quiz/categories"}).catch(e=>{var t=window.category;t&&topic?window.location.href=`/quiz/${t}/${window.subcategory}/`+window.currentQuizTitle:window.location.href="/quiz/categories"})}function setupLanguageFilterListeners(){document.getElementById("language-speed-dial-btn"),document.getElementById("speed-dial-menu-bottom-right");var e=document.getElementById("vietnamese-filter-btn"),t=document.getElementById("hungarian-filter-btn"),n=document.getElementById("all-filter-btn");e&&e.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),setLanguageFilter("vietnamese")}),t&&t.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),setLanguageFilter("hungarian")}),n&&n.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),setLanguageFilter("all")})}function setLanguageFilter(e){currentLanguageFilter=e,updateFilterButtonStates(),applyLanguageFilter()}function updateFilterButtonStates(){["vietnamese-filter-btn","hungarian-filter-btn","all-filter-btn"].forEach(e=>{e=document.getElementById(e);e&&e.classList.remove("ring-2","ring-blue-500")});let e="all-filter-btn";"vietnamese"===currentLanguageFilter?e="vietnamese-filter-btn":"hungarian"===currentLanguageFilter&&(e="hungarian-filter-btn");var t=document.getElementById(e);t&&t.classList.add("ring-2","ring-blue-500")}function applyLanguageFilter(){var e,t=document.getElementById("questionText");t&&questions[currentQuestionIndex]&&(e=filterText(questions[currentQuestionIndex].question),t.textContent=e),document.querySelectorAll(".option-card").forEach((e,t)=>{let n=e.querySelector("label");n&&questions[currentQuestionIndex]&&questions[currentQuestionIndex].options[t]&&(e=filterText(questions[currentQuestionIndex].options[t]),t=n.querySelectorAll(".correct-icon, .wrong-icon"),n.innerHTML=e,t.forEach(e=>n.appendChild(e)))})}function filterText(e){if(!e)return"";switch(currentLanguageFilter){case"vietnamese":var t=e.match(/\(([^)]+)\)/g);return t?t.map(e=>e.slice(1,-1)).join(" "):e;case"hungarian":return e.replace(/\s*\([^)]*\)/g,"").trim();default:return e}}document.addEventListener("DOMContentLoaded",function(){function n(){var e;window.quizQuestionsData&&Array.isArray(window.quizQuestionsData)&&0<window.quizQuestionsData.length?(initializeQuizData(window.quizQuestionsData),0<questions.length?loadQuestion(0):((e=document.getElementById("questionText")).removeAttribute("data-translate"),window.languageManager?e.textContent=window.languageManager.translate("quiz.error")||"No questions available for this quiz.":e.textContent="No questions available for this quiz.")):((e=document.getElementById("questionText")).removeAttribute("data-translate"),window.languageManager?e.textContent=window.languageManager.translate("quiz.error")||"Error loading quiz data.":e.textContent="Error loading quiz data."),setupEventListeners(),setTimeout(()=>{setupLanguageFilterListeners()},100)}if(window.languageManager&&window.languageManager.currentLanguage)n();else{let e=0,t=()=>{e++,(!window.languageManager||!window.languageManager.currentLanguage)&&e<50?setTimeout(t,100):n()};setTimeout(t,100)}});